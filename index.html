<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camino Invoice Checker v3</title>
    <style>
        :root {
            --primary: #FFB512;
            --secondary: #121C33;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--secondary);
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            color: var(--secondary);
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-section {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .file-input {
            margin-bottom: 15px;
        }

        .file-input input {
            margin-top: 5px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .submit-btn {
            background-color: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            font-size: 16px;
        }

        .submit-btn:hover {
            opacity: 0.9;
        }

        .error-message {
            display: none;
            color: red;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid red;
            border-radius: 4px;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .check-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }

        .icon {
            font-size: 24px;
            margin-right: 15px;
            min-width: 30px;
            text-align: center;
        }

        .check-content {
            flex-grow: 1;
        }

        .check-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--primary);
            border-radius: 8px;
            color: var(--secondary);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-info {
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Camino Invoice Checker</h1>
        
        <div class="upload-section">
            <div class="file-input">
                <label for="po">Purchase Order:</label><br>
                <input type="file" id="po" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this, 'po-info')">
                <div id="po-info" class="file-info"></div>
            </div>
            
            <div class="file-input">
                <label for="invoice">Draft Invoice:</label><br>
                <input type="file" id="invoice" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this, 'invoice-info')">
                <div id="invoice-info" class="file-info"></div>
            </div>
            
            <div>
                <label for="api-key">Claude API Key:</label><br>
                <input type="password" id="api-key" class="api-input" placeholder="Enter your API key">
            </div>
            
            <button class="submit-btn" onclick="validateInvoice()">Validate Invoice</button>
            <div id="error-message" class="error-message"></div>
        </div>

        <div class="loading">
            <div class="spinner"></div>
            <p>Analyzing documents...</p>
        </div>

        <div class="results">
            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">Job Number and Description</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">PO Number Match</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">Billing Address</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">Currency Match</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">VAT Application</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="check-item">
                <div class="icon">✓</div>
                <div class="check-content">
                    <div class="check-title">Payment Terms</div>
                    <div class="check-explanation"></div>
                </div>
            </div>

            <div class="summary">
                <h3>The Queen's Verdict</h3>
                <p id="summary-text"></p>
            </div>
        </div>
    </div>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function handleFileSelect(input, infoId) {
            const infoDiv = document.getElementById(infoId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                infoDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            } else {
                infoDiv.textContent = '';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        resolve(event.target.result);
                    } catch (e) {
                        reject(new Error(`Failed to read file: ${e.message}`));
                    }
                };
                
                reader.onerror = (event) => {
                    reject(new Error(`File read error: ${event.target.error}`));
                };

                reader.onprogress = (event) => {
                    if (event.loaded && event.total) {
                        const percent = (event.loaded / event.total) * 100;
                        console.log(`Loading file: ${percent.toFixed(1)}%`);
                    }
                };

                try {
                    reader.readAsText(file);
                } catch (e) {
                    reject(new Error(`Failed to start file read: ${e.message}`));
                }
            });
        }

        async function validateInvoice() {
            const errorElement = document.getElementById('error-message');
            const loadingElement = document.querySelector('.loading');
            const resultsElement = document.querySelector('.results');

            try {
                // Reset display states
                errorElement.style.display = 'none';
                loadingElement.style.display = 'none';
                resultsElement.style.display = 'none';

                // Get file inputs
                const poFile = document.getElementById('po').files[0];
                const invoiceFile = document.getElementById('invoice').files[0];
                const apiKey = document.getElementById('api-key').value;

                if (!poFile || !invoiceFile || !apiKey) {
                    throw new Error('Please provide all required files and API key');
                }

                loadingElement.style.display = 'block';

                // Read files
                console.log('Reading PO file...');
                const poContent = await readFileAsText(poFile);
                console.log('Reading invoice file...');
                const invoiceContent = await readFileAsText(invoiceFile);

                console.log('Calling API...');
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: "claude-3-opus-20240229",
                        max_tokens: 1024,
                        messages: [{
                            role: "user",
                            content: `Analyze these documents:\n\nPO:\n${poContent}\n\nInvoice:\n${invoiceContent}\n\n
                            Please check the following criteria and provide a response in JSON format:
                            1. Does the invoice specify a job number (format: JJEUGA2401) and description?
                            2. Does the invoice specify a PO number and does it match the supplied PO?
                            3. Does the invoice address match the PO's "bill to" address?
                            4. Does the currency match between PO and invoice?
                            5. Is VAT correctly applied based on the billing address?
                            6. Do the payment terms match the PO requirements?

                            Provide your response in this exact JSON format:
                            {
                                "jobNumber": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "poNumber": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "billingAddress": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "currency": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "vat": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "paymentTerms": {
                                    "pass": true/false,
                                    "explanation": "detailed explanation"
                                },
                                "summary": "A sassy, queen-like summary of the overall invoice quality"
                            }`
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                console.log('Processing response...');
                const data = await response.json();
                const result = JSON.parse(data.content[0].text);
                
                // Update the results in the UI
                const checks = ['jobNumber', 'poNumber', 'billingAddress', 'currency', 'vat', 'paymentTerms'];
                checks.forEach((check, index) => {
                    const checkItem = document.querySelectorAll('.check-item')[index];
                    const icon = checkItem.querySelector('.icon');
                    const explanation = checkItem.querySelector('.check-explanation');
                    
                    icon.textContent = result[check].pass ? '✓' : '✗';
                    icon.style.color = result[check].pass ? 'green' : 'red';
                    explanation.textContent = result[check].explanation;
                });

                document.getElementById('summary-text').textContent = result.summary;
                resultsElement.style.display = 'block';

            } catch (error) {
                console.error('Error details:', error);
                showError(`Error: ${error.message}`);
            } finally {
                loadingElement.style.display = 'none';
            }
        }
    </script>
</body>
</html>
