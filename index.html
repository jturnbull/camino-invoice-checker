<!DOCTYPE html>
<html lang="en">
<!-- Previous head and style sections remain the same -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camino Invoice Checker</title>
    <style>
        /* Previous styles remain the same */
        .error-message {
            display: none;
            color: red;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffebee;
            border: 1px solid red;
            border-radius: 4px;
        }
        
        .file-info {
            margin-top: 5px;
            font-size: 0.8em;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Camino Invoice Checker</h1>
        
        <div class="upload-section">
            <div class="file-input">
                <label for="po">Purchase Order:</label><br>
                <input type="file" id="po" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this, 'po-info')">
                <div id="po-info" class="file-info"></div>
            </div>
            
            <div class="file-input">
                <label for="invoice">Draft Invoice:</label><br>
                <input type="file" id="invoice" accept=".pdf,.doc,.docx" onchange="handleFileSelect(this, 'invoice-info')">
                <div id="invoice-info" class="file-info"></div>
            </div>
            
            <div>
                <label for="api-key">Claude API Key:</label><br>
                <input type="password" id="api-key" class="api-input" placeholder="Enter your API key">
            </div>
            
            <button class="submit-btn" onclick="validateInvoice()">Validate Invoice</button>
            <div id="error-message" class="error-message"></div>
        </div>

        <div class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing documents...</p>
        </div>

        <div class="results" style="display: none;">
            <!-- Previous results section remains the same -->
        </div>
    </div>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function handleFileSelect(input, infoId) {
            const infoDiv = document.getElementById(infoId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                infoDiv.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            } else {
                infoDiv.textContent = '';
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    reject(new Error('No file provided'));
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        resolve(event.target.result);
                    } catch (e) {
                        reject(new Error(`Failed to read file: ${e.message}`));
                    }
                };
                
                reader.onerror = (event) => {
                    reject(new Error(`File read error: ${event.target.error}`));
                };

                reader.onprogress = (event) => {
                    if (event.loaded && event.total) {
                        const percent = (event.loaded / event.total) * 100;
                        console.log(`Loading file: ${percent.toFixed(1)}%`);
                    }
                };

                try {
                    reader.readAsText(file);
                } catch (e) {
                    reject(new Error(`Failed to start file read: ${e.message}`));
                }
            });
        }

        async function validateInvoice() {
            const errorElement = document.getElementById('error-message');
            const loadingElement = document.querySelector('.loading');
            const resultsElement = document.querySelector('.results');

            // Reset display states
            errorElement.style.display = 'none';
            loadingElement.style.display = 'none';
            resultsElement.style.display = 'none';

            try {
                // Get file inputs
                const poFile = document.getElementById('po').files[0];
                const invoiceFile = document.getElementById('invoice').files[0];
                const apiKey = document.getElementById('api-key').value;

                // Validate inputs
                if (!poFile || !invoiceFile) {
                    throw new Error('Please select both PO and invoice files');
                }

                if (!apiKey) {
                    throw new Error('Please enter your API key');
                }

                // Show loading state
                loadingElement.style.display = 'block';

                // Read files
                console.log('Reading PO file...');
                const poContent = await readFileAsText(poFile);
                console.log('Reading invoice file...');
                const invoiceContent = await readFileAsText(invoiceFile);

                // Prepare API request
                const requestBody = {
                    model: "claude-3-opus-20240229",
                    max_tokens: 1024,
                    messages: [{
                        role: "user",
                        content: `Analyze these documents:\n\nPO:\n${poContent}\n\nInvoice:\n${invoiceContent}`
                    }]
                };

                console.log('Calling API...');
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Processing response...');
                
                // Update results
                resultsElement.style.display = 'block';
                // Update results implementation...

            } catch (error) {
                console.error('Error details:', error);
                showError(`Error: ${error.message}`);
            } finally {
                loadingElement.style.display = 'none';
            }
        }
    </script>
</body>
</html>
